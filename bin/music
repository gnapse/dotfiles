#!/usr/bin/env ruby

class App
  def initialize
    @options = ARGV.shift if ARGV.first =~ /\A-[a-z]+\z/
    @options = ARGV.pop if ARGV.last =~ /\A-[a-z]+\z/
    @command = ARGV.first
    @query = ARGV.map { |arg| "\"#{arg}\"" }.join(" ")
  end

  def run
    case @command
    when "list"
      exec "mpc playlist --format=\"%position% ~ %artist% ~ %album% ~ %title% ~ %time%\" | align '~' '  ' | less -ci~"
    when "info" then cmd "mpc status", true
    when "player" then exec "pms -c #{ENV['DOTFILES']}/pmsrc"
    when "shuffle"
      cmd "mpc random off"
      cmd "mpc shuffle", true
    when VERBATIM_COMMANDS
      cmd "mpc #{@query}", true
    when SEARCH_COMMANDS
      if option?(:l)
        cmd "mpc search #{@query}", true
      else
        cmd "mpc clear" unless option?(:a)
        cmd "mpc search #{@query} | mpc add"
        cmd "mpc random on" if option?(:r)
        if option?(:s)
          cmd "mpc random off"
          cmd "mpc shuffle"
        end
        cmd "mpc play", true
      end
    else
      puts "Invalid command #{@command}"
      exit(1)
    end
  end

  private

  VERBATIM_COMMANDS = /\A(play|stop|pause|prev|next|clear|status|toggle|update|crop|current|del|move|random|volume)\z/
  SEARCH_COMMANDS = /\A(album|any|artist|comment|composer|date|disc|filename|genre|name|performer|title|track)\z/

  def cmd(line, print_output = false)
    if print_output
      system line
    else
      `#{line}`
    end
  end

  def option?(opt)
    @options.include?(opt.to_s)
  rescue
    false
  end
end

App.new.run
