#!/usr/bin/env ruby

class App
  def initialize
    @options = ARGV.shift if ARGV.first.start_with?("-")
    @options = ARGV.pop if ARGV.last.start_with?("-")
    @command = ARGV.first
    @query = ARGV.map { |arg| "\"#{arg}\"" }.join(" ")
  end

  def run
    case @command
    when "list" then list
    when "info" then cmd "mpc status", true
    when "random" then cmd "mpc random #{@query}", true
    when "shuffle"
      cmd "mpc random off"
      cmd "mpc shuffle"
      list "mpc status"
    when VERBATIM_COMMANDS
      cmd "mpc #{@command}", true
    when SEARCH_COMMANDS
      if option?(:l)
        cmd "mpc search #{@query}", true
      else
        cmd "mpc clear" unless option?(:a)
        cmd "mpc search #{@query} | mpc add"
        cmd "mpc random on" if option?(:r)
        if option?(:s)
          cmd "mpc random off"
          cmd "mpc shuffle"
        end
        list "mpc play"
      end
    else
      puts "Invalid command #{@command}"
      exit(1)
    end
  end

  private

  VERBATIM_COMMANDS = /\A(play|stop|pause|prev|next|clear|status|toggle|update)\z/
  SEARCH_COMMANDS = /\A(album|any|artist|comment|composer|date|disc|filename|genre|name|performer|title|track)\z/

  def list(extra_command = nil)
    puts "\nCurrent Playlist"
    cmd "mpc playlist --format=\"%artist% - %album% - %title%\"", true
    if extra_command
      puts
      cmd extra_command, true
    end
  end

  def cmd(line, print_output = false)
    if print_output
      system line
    else
      `#{line}`
    end
  end

  def option?(opt)
    @options.include?(opt.to_s)
  rescue
    false
  end
end

App.new.run
